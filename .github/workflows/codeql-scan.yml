on:
  push:
    branches:
      - master
      - code-ql-scan

name: 'CodeQL Security Scan'

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Checkout Submodules
      run: |
        git submodule init
        git submodule update

    - name: Run CodeQL Scan
      env:
        SCAN_PATH='../../'
      run: |
        cd .ci/openenclave-security
        bash scripts/run.sh

    - name: Run LS
      run: ls -l .ci/openenclave-security

    - name: Verify SARIF file
      id: sarif_file
      uses: andstor/file-existence-action@v1
      with:
        files: ".ci/openenclave-security/build/OpenEnclave.sarif"

    - name: Upload SARIF file
      if: steps.sarif_file.outputs.files_exists == 'true'
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: .ci/openenclave-security/build/OpenEnclave.sarif
